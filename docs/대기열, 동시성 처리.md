## **대기열 처리 방식**

### **개요**

대기열 처리 방식에 대해 고민해보았습니다. 보편적으로 아래 두 방식을 사용하고 있었습니다.

### **1. 은행창구 방식**

사람들이 차례대로 줄 서 있으면 1번 사람 입장 후 나머지 사람 대기, 1번 사람 **완료 후** 2번 사람 입장 후 나머지 사람 대기, 2번 사람 완료 후 3번 사람 .... 이렇게 은행 대기표 처럼 **순차적**으로 처리하는 방식

**장점**:

- **순서성 보장**: 사용자가 순차적으로 처리.
- **관리 간편**: 대기열에서 한 명씩 처리하기 때문에 대기열 관리 비교적 단순
- **부하 방지가 편함**

**단점**:

- **처리 속도 저하**: 대규모 사용자 몰릴 시 대기 시간 매우 김
- **불공평한 대기시간**: 내가 언제 들어갈 수 있는지 **정확한 판단 힘듬**. 1번이 처리가 오래 걸린다면 5번은 그만큼 기다려야 하기 때문.

### **2. 놀이공원 방식**

사람들이 차례대로 줄 서 있으면 1-30번 사람 입장 후 나머지 사람 대기, **일정 시간 후** 31-60번 사람 입장 후 나머지 사람 대기, 일정 시간 후  .... 이렇게 놀이공원처럼 **주기적으로** 여러 사람이 한번에 들어가는 방식

**장점**:

- **안정적인 속도**로 사용자 인입 가능
- **정확한 서비스 이용 가능 시간 제공**

**단점**:

- **처리 지연**: 주기적으로 한꺼번에 처리하므로, 처리 주기와 일치하지 않는 사용자는 더 오랜 시간을 기다릴 가능성 up
- **복잡한 대기열 관리**: 특정 인원만큼 배치로 처리하기 때문에, 배치 크기 조정이나 처리 주기에 대한 관리 복잡.

### **결론**

**은행창구 방식**은 사용자가 적을때, **놀이공원 방식**은 사용자가 많을 때 필요한 것으로 사료되었습니다. 따라서 이번 3~5 주차 콘서트 예약은 은행 창구 방식, 6주차 이후 redis 를 이용한 대용량 트래픽 제어 방식에서는 놀이공원 방식을 사용하여 속도를 비교해 보고자 합니다.



## 대기열

### 개요

대기열이 무엇이고, 사용이유에 대해 정리한 내용입니다. 처음 대기열 처리 방식에 대해 생각했을때 동시성과 연관지어 생각한 점이 커서, 동시성과 분리해여 대기열이 무엇인지 개념 정리하는 목적으로 작성합니다.

### 대기열이란?

대용량(10만명 이상) 의 데이터가 들어올 때 한 곳에 몰리면 리소스 부하가 크기 때문에 일정한 크기, 혹은 순차적으로 데이터를 처리할 수 있게 만드는 시스템.

### 사용 이유

* 트래픽 제어
* 여러 자원이 하나의 자원에 접근해서 동시에 수정하려 할때 사용.

### 콘서트 예약 서비스에서의 대기열

콘서트를 예약 할 때 부하가 가장 크기 때문에 사용자 순번은 대기열 로직에서, 콘서트 예약은 대기열에서 내 차례가 왔을때 가능하도록 설계할 것 입니다.



## 동시성 처리

### 개요

사용자 트래픽은 대기열에서 제어하게 되었지만, 좌석 예약은 사용자가 동시에 접근 할 수 있기 때문에 좌석 예약 시 동시성 제어를 설계했습니다. 아래는 동시성 처리를 위해 고민한 비관적 락과 낙관적 락에 대한 내용입니다.

### 1. 비관적 락

모든 요청에 대해서 락을 걸을 거는 방식. **실패한 요청에 대해 db threadpool 저장해두고 재사용.**

**장점**:

* **데이터 일관성 보장**: 데이터를 읽거나 수정하는 동안 다른 트랜잭션이 동일한 데이터에 접근하지 못하므로, **데이터 충돌**이 발생 하지 않음.
* **안정성**

**단점**:

- **장시간 락**

### 2. 낙관적 락

충돌이 나는 요청에 대해서만 락을 거는 방식. **1개 성공하면 나머지 요청 실패 처리.**

**장점**:

- **충돌이 적은 환경에서 유리**: 데이터 충돌이 드문 경우 효율적

**단점**:

- **복잡한 로직**: 충돌 발생 시 애플리케이션에서 해당 로직 처리. 

### 결론

좌석 예약의 경우 빈번한 충돌 가능성이 높기 때문에 **비관적 락**을 이용해 좌석 예약 시 동시성을 제어하는 방향으로 설계했습니다.

